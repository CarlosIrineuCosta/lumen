# Lumen Development Tasks — 2025-11-15

## BIG NOTE

**THIS DOCUMENT HAS BEEN ARCHIVED TO `archive/task_documents/tasks_2025-10-22.md`**

This is a historical document containing development tasks from October-November 2025. The information here is no longer current and has been superseded by newer documentation. Please refer to the current documentation in the `docs/core/` directory for up-to-date information.

---


## Context Snapshot

- **Goal:** Stabilize the PMM-based glass UI to achieve a working MVP with OAuth login, gallery browsing, uploads, and profile management
- **Status:** Backend is production-ready with comprehensive API; frontend has critical authentication state management issues blocking MVP
- **Priority:** Fix authentication state race condition and API connectivity problems
- **Approach:** Focus on immediate stability improvements before adding new features

## Project Architecture Summary

- **Backend**: FastAPI + PostgreSQL + Redis (complete and stable)
- **Frontend**: Poor Man's Modules (PMM) pattern with global window.Lumen* objects
- **Key Challenge**: Router loads before Firebase auth restores session, causing "Please sign in" toast spam
- **Critical Fix**: `LumenGallery.loadMyPhotos()` uses wrong auth property (`currentUser` instead of `user`)

## Critical Issues to Address

### 1. Authentication State Management (CRITICAL)
- **Problem:** Auth-protected routes emit "Please sign in…" toasts when hash is pre-set before Firebase restores session
- **Impact:** Users cannot access protected content directly via URL
- **Root Cause:** Router loads before auth state is restored

### 2. API Connection Issues (CRITICAL)
- **Problem:** Frontend cannot consistently reach backend (fetch failures)
- **Impact:** Gallery fetches hit `LumenAPI.request()` error handling
- **Root Cause:** CORS configuration and credential handling

### 3. Module Reference Errors (HIGH)
- **Problem:** `LumenGallery.loadMyPhotos()` references `window.LumenAuth?.currentUser` (incorrect property)
- **Impact:** Photo management always fails even when authenticated
- **Root Cause:** Inconsistent auth state property names

## Development Roadmap

### Phase 1: Critical Stability Fixes (Week 1)

#### 1.1 Fix Authentication Flow
- [ ] **Task:** Implement auth state initialization guard
  - **File:** `frontend/js/modules/auth.js`
  - **Action:** Add `isAuthReady()` method that returns Promise
  - **Acceptance:** Router waits for auth ready before navigation

- [ ] **Task:** Fix auth state property references
  - **File:** `frontend/js/modules/gallery.js:930`
  - **Action:** Change `window.LumenAuth?.currentUser` to `window.LumenAuth?.user`
  - **Acceptance:** Photo management works after sign-in

- [ ] **Task:** Add auth restoration loading state
  - **File:** `frontend/js/app.js`
  - **Action:** Show loading indicator during Firebase auth restoration
  - **Acceptance:** No toast spam during app initialization

#### 1.2 Stabilize API Connections
- [ ] **Task:** Verify CORS configuration
  - **File:** `backend/app/main.py:36-61`
  - **Action:** Ensure credentials: 'include' is properly handled
  - **Acceptance:** API calls succeed from frontend

- [ ] **Task:** Fix API request headers
  - **File:** `frontend/js/modules/api.js:27-93`
  - **Action:** Ensure Authorization header is properly set
  - **Acceptance:** Authenticated API calls work

- [ ] **Task:** Add connection retry logic
  - **File:** `frontend/js/modules/api.js`
  - **Action:** Implement exponential backoff for failed requests
  - **Acceptance:** Temporary connection issues are transparently handled

#### 1.3 Router State Management
- [ ] **Task:** Implement route guards
  - **File:** `frontend/js/modules/router.js:92-138`
  - **Action:** Add auth check before route navigation
  - **Acceptance:** Protected routes redirect to auth modal

- [ ] **Task:** Fix hash route handling
  - **File:** `frontend/js/modules/router.js:85-89`
  - **Action:** Ensure hash changes trigger proper navigation
  - **Acceptance:** Browser back/forward works correctly

### Phase 2: Core Functionality Stabilization (Week 2)

#### 2.1 Profile Management
- [ ] **Task:** Fix profile modal display
  - **File:** `frontend/js/modules/profile.js:528`
  - **Action:** Ensure `showProfile()` renders correctly
  - **Acceptance:** Profile modal opens and displays user data

- [ ] **Task:** Implement profile CRUD operations
  - **File:** `frontend/js/modules/profile.js:554-585`
  - **Action:** Connect form to backend endpoints
  - **Acceptance:** Profile changes persist to backend

#### 2.2 Upload Functionality
- [ ] **Task:** Fix upload modal structure
  - **File:** `frontend/index.html:88-114`
  - **Action:** Ensure modal IDs match JS expectations
  - **Acceptance:** Upload modal opens when triggered

- [ ] **Task:** Connect FilePond to backend
  - **File:** `frontend/js/modules/upload.js:162-232`
  - **Action:** Verify endpoint configuration
  - **Acceptance:** Photo uploads successfully store images

#### 2.3 Gallery Management
- [ ] **Task:** Fix photo loading errors
  - **File:** `frontend/js/modules/gallery.js:139-185`
  - **Action:** Add proper error handling for API failures
  - **Acceptance:** Gallery shows meaningful error messages

- [ ] **Task:** Implement photo management mode
  - **File:** `frontend/js/modules/gallery.js:855-872`
  - **Action:** Enable edit/delete functionality for owners
  - **Acceptance:** Users can manage their photos

### Phase 3: User Experience Polish (Week 3)

#### 3.1 Loading States
- [ ] **Task:** Add loading indicators
  - **Files:** All module files
  - **Action:** Show loading states during async operations
  - **Acceptance:** Users see feedback during loading

#### 3.2 Error Handling
- [ ] **Task:** Implement error boundaries
  - **File:** `frontend/js/app.js:84-104`
  - **Action:** Catch and display errors gracefully
  - **Acceptance:** Errors don't break the entire app

#### 3.3 Mobile Optimization
- [ ] **Task:** Fix touch interactions
  - **Files:** `frontend/css/`
  - **Action:** Ensure mobile tap targets are properly sized
  - **Acceptance:** Mobile users can interact with all elements

### Phase 4: Backend Optimization (Week 4)

#### 4.1 Database Connection Pooling
- [ ] **Task:** Replace NullPool with bounded pool
  - **File:** `backend/app/database/connection.py`
  - **Action:** Implement proper connection pooling for FastAPI
  - **Acceptance:** Database connections are properly managed

#### 4.2 Input Validation
- [ ] **Task:** Tighten location service filtering
  - **File:** `backend/app/services/location_service.py`
  - **Action:** Replace broad `.contains` with exact matching
  - **Acceptance:** Location queries are secure and efficient

#### 4.3 Cache Strategy
- [ ] **Task:** Implement consistent cache invalidation
  - **Files:** `backend/app/services/photo_service*.py`
  - **Action:** Add cache invalidation on photo updates
  - **Acceptance:** Cache stays consistent with data

## Parallel Development Task Assignment

### Claude (Frontend Focus)
**Primary Responsibilities**: Authentication state management, router coordination, UI components
- **Phase 1 Tasks**:
  - Implement `isAuthReady()` Promise method in auth module
  - Fix auth state property references (`currentUser` → `user`)
  - Add auth restoration loading states
  - Implement router guards with auth checking
- **Phase 2 Tasks**:
  - Fix upload modal structure and FilePond integration
  - Rebuild profile modal with CRUD operations
  - Add gallery error handling and loading states
- **Deliverables**: Working auth flow, stable navigation, functional upload/profile modals

### Codex (Backend Focus)
**Primary Responsibilities**: Database optimization, security, API performance
- **Phase 4 Tasks**:
  - Replace NullPool with bounded connection pooling
  - Tighten location service input filtering
  - Implement consistent cache invalidation strategy
- **Security & Performance**:
  - Review and fix any API endpoint security issues
  - Optimize database queries for production load
  - Implement proper rate limiting if needed
- **Deliverables**: Production-ready backend with proper connection management and security

### GLM (Testing & Validation Focus)
**Primary Responsibilities**: Test execution, integration verification, quality assurance
- **Testing Strategy Execution**:
  - Run and fix backend test suite failures
  - Implement frontend integration tests
  - Verify CORS configuration end-to-end
  - Test authentication flows comprehensively
- **Quality Assurance**:
  - Manual testing of all MVP features
  - Performance benchmarking (page load, API response times)
  - Mobile responsiveness validation
  - Cross-browser compatibility testing
- **Deliverables**: Comprehensive test coverage, validation reports, bug documentation

### Coordination Protocol
1. **Daily Sync**: Each agent updates progress in shared task document
2. **Dependencies**: Frontend (Claude) depends on backend stability (Codex) for full integration
3. **Integration**: GLM validates integration between Claude's frontend fixes and Codex's backend changes
4. **Code Review**: Cross-agent review for critical changes affecting multiple components

## Testing Strategy

### Agent-Specific Testing Responsibilities

#### GLM (Lead Tester) - Primary Testing Execution
**Backend Test Suite Management**:
- [ ] Run existing test suite: `python -m pytest backend/tests -v`
- [ ] Fix failing tests in `scripts/tests/test_photo_endpoints.py` and `test_photo_model.py`
- [ ] Stabilize PostgreSQL test database setup
- [ ] Achieve >70% coverage threshold (target: 85%)

**Integration Testing**:
- [ ] Test authentication flow end-to-end (Firebase + Backend + Frontend)
- [ ] Verify CORS configuration works across all browsers
- [ ] Test photo upload workflow (FilePond → API → Storage)
- [ ] Validate profile CRUD operations persist correctly

**Quality Assurance**:
- [ ] Manual testing of all MVP features
- [ ] Performance benchmarking (page load times, API response times)
- [ ] Mobile responsiveness validation
- [ ] Cross-browser compatibility testing

#### Claude (Frontend Developer) - Frontend Testing
**Frontend Module Testing**:
- [ ] Test authentication state management race condition fix
- [ ] Verify router guards work correctly for protected routes
- [ ] Test upload modal functionality and FilePond integration
- [ ] Validate profile modal renders and saves correctly

**User Experience Testing**:
- [ ] Test loading states and error messages
- [ ] Verify navigation flows work smoothly
- [ ] Test gallery management mode for photo owners
- [ ] Validate touch interactions on mobile devices

#### Codex (Backend Developer) - Backend Testing
**Backend Service Testing**:
- [ ] Test database connection pooling under load
- [ ] Verify location service input filtering security
- [ ] Test cache invalidation consistency
- [ ] Validate API endpoint security and performance

**Security Testing**:
- [ ] Test for SQL injection vulnerabilities
- [ ] Verify file upload validation and security
- [ ] Test authentication JWT token handling
- [ ] Validate rate limiting if implemented

### Combined Testing Workflow

#### Daily Testing Routine
1. **GLM**: Run automated backend test suite and report results
2. **Claude**: Test frontend features affected by backend changes
3. **Codex**: Verify backend stability under frontend load
4. **Integration**: GLM tests full user flows across all components

#### Critical Test Scenarios
- [ ] **Authentication Race**: Access protected route before Firebase restores session
- [ ] **Upload Workflow**: Complete photo upload from selection to storage
- [ ] **Profile Management**: Edit and save user profile with validation
- [ ] **Gallery Loading**: Load gallery with various network conditions
- [ ] **Error Recovery**: App behavior during network failures and API errors

#### Performance Benchmarks
- [ ] Page load time: <2 seconds on 3G connection
- [ ] API response time: <100ms for cached endpoints
- [ ] Database query time: <50ms for optimized queries
- [ ] File upload speed: Progress indication for >10MB files

## Deployment Plan

### Development Environment
1. Frontend: `cd frontend && python -m http.server 8000`
2. Backend: `cd backend && uvicorn app.main:app --reload --port 8080`
3. Database: PostgreSQL on localhost:5432
4. Redis: localhost:6379

### Production Deployment
1. **Pre-deployment Checklist**
   - [ ] All tests passing
   - [ ] Security review complete
   - [ ] Performance benchmarks met
   - [ ] Documentation updated

2. **Deployment Steps**
   - [ ] Backup current production
   - [ ] Deploy backend to Swiss VPS
   - [ ] Update frontend files
   - [ ] Run smoke tests
   - [ ] Monitor for issues

## Success Metrics

### Technical Metrics
- [ ] All critical issues resolved
- [ ] Test suite passes with >70% coverage
- [ ] Page load time <2 seconds
- [ ] API response time <100ms

### User Experience Metrics
- [ ] Auth flow completes without errors
- [ ] Gallery loads photos successfully
- [ ] Upload works for all file types
- [ ] Profile management is intuitive

### Agent-Specific Deliverables

#### Claude (Frontend) Success Criteria
- [ ] Authentication race condition eliminated - no more toast spam on protected routes
- [ ] Router properly waits for Firebase auth restoration before navigation
- [ ] Upload modal opens reliably and FilePond successfully connects to backend
- [ ] Profile modal renders and persists changes to backend
- [ ] Gallery shows meaningful error messages instead of failing silently

#### Codex (Backend) Success Criteria
- [ ] Database connection pooling implemented and production-ready
- [ ] Location service uses exact matching instead of broad .contains queries
- [ ] Cache invalidation works consistently across photo operations
- [ ] All API endpoints handle load without connection churn
- [ ] Security review passed with no critical vulnerabilities

#### GLM (Testing) Success Criteria
- [ ] Backend test suite passes with >70% coverage (target: 85%)
- [ ] Integration tests cover critical user flows (auth, upload, profile)
- [ ] Performance benchmarks meet targets (page load <2s, API <100ms)
- [ ] Mobile responsiveness validated across device sizes
- [ ] Bug documentation complete with reproduction steps

### Integration Success Indicators
- [ ] Frontend auth flow works seamlessly with backend Firebase validation
- [ ] Photo uploads complete end-to-end from FilePond to database storage
- [ ] Profile changes persist correctly through API to database
- [ ] Gallery loads user photos in management mode without auth errors
- [ ] No CORS or credential issues across any browser

## Risk Mitigation

### Technical Risks
1. **Authentication Complexity**
   - **Mitigation:** Implement proper state management
   - **Contingency:** Fall back to simpler auth flow

2. **API Instability**
   - **Mitigation:** Add comprehensive error handling
   - **Contingency:** Implement offline mode

3. **Module Dependencies**
   - **Mitigation:** Clear initialization order
   - **Contingency:** Bundle critical modules

### Timeline Risks
1. **Scope Creep**
   - **Mitigation:** Strict focus on MVP features
   - **Contingency:** Defer non-critical features

2. **Technical Debt**
   - **Mitigation:** Address issues as they arise
   - **Contingency:** Allocate time for refactoring

## Immediate Next Steps - November 15, 2025

### Today (Priority Order)
1. **Claude**: Fix authentication state property reference
   - Change `window.LumenAuth?.currentUser` to `window.LumenAuth?.user` in `gallery.js:875`
   - Test photo management mode functionality
   - Verify auth state initialization works correctly

2. **Codex**: Verify CORS configuration is working
   - Check `backend/app/main.py:36-61` credentials handling
   - Test API calls from frontend to backend
   - Confirm no CORS errors in browser console

3. **GLM**: Run critical test scenarios
   - Execute `python -m pytest backend/tests -v`
   - Identify and document any failing tests
   - Test authentication flow end-to-end

### This Week (Week of Nov 15-19)

#### Monday-Tuesday
- **Claude**: Implement `isAuthReady()` Promise method in auth module
- **Codex**: Review backend test failures and fix critical issues
- **GLM**: Set up stable test database environment

#### Wednesday-Thursday
- **Claude**: Add auth restoration loading states and router guards
- **Codex**: Begin database connection pooling implementation
- **GLM**: Test integration between auth fixes and backend validation

#### Friday
- **All agents**: End-to-end integration testing of auth flow
- **GLM**: Performance benchmarking and bug documentation
- **Claude**: Verify all authentication race conditions are resolved

### Success Criteria for This Week
- [ ] No more "Please sign in" toast spam when accessing protected routes
- [ ] Backend test suite runs without failures
- [ ] API connections work reliably between frontend and backend
- [ ] Router properly waits for auth before navigation

### Blockers to Watch
- **Firebase initialization timing** - May require additional loading states
- **Test database stability** - Could slow down backend validation
- **CORS credential handling** - Might need backend configuration changes

## Resources

### Documentation
- [Architecture Summary](docs/core/ARCHITECTURE_SUMMARY.md)
- [Tech Stack](docs/core/_TECH_STACK.md)
- [Development Guide](docs/core/DEVELOPMENT.md)

### Tools and Commands
- Start servers: `./scripts/server-manager.sh start`
- Run tests: `python -m pytest backend/tests -v`
- Verify code: `python scripts/agent_protocol.py verify <files>`

### Contacts
- Development Team: Available via team channels
- Infrastructure Support: Contact for VPS issues
- Security Review: Schedule before production deployment

---

## Document Status

**This document is the Single Source of Truth for Lumen development tasks as of November 15, 2025.**

- All previous task files have been archived to `backup/docs/`
- Updates to this document should be made by consensus of all agents
- Progress should be tracked by updating task completion status
- New tasks must follow the established format with clear acceptance criteria

**Remember:** The goal is a stable MVP with the core PMM architecture working reliably. Focus on the critical issues first before adding new features. Keep modules under 400 lines and maintain the no-build-tools philosophy.

**Last Updated**: 2025-11-15
**Next Review**: End of week development sync
