<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Profile - Lumen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #f0f6fc;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .registration-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            margin: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .logo {
            font-size: 32px;
            font-weight: bold;
            color: #f0f6fc;
            margin-bottom: 8px;
        }
        
        .subtitle {
            color: #8b949e;
            font-size: 16px;
        }
        
        .form-section {
            margin-bottom: 32px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #f0f6fc;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group-inline {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .form-group-inline .form-group {
            margin-bottom: 0;
            flex: 1;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #f0f6fc;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #0d1117;
            color: #f0f6fc;
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #21262d;
            padding: 8px 12px;
            border-radius: 16px;
            border: 1px solid #30363d;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .checkbox-item:hover {
            background: #30363d;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .checkbox-item.selected {
            background: #1f6feb;
            border-color: #58a6ff;
        }
        
        .btn {
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: opacity 0.2s;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .error-message {
            background: #da3633;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .success-message {
            background: #238636;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #8b949e;
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <div class="registration-container">
        <div class="header">
            <div class="logo">Lumen</div>
            <div class="subtitle">Complete your photographer profile</div>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        
        <form id="registrationForm">
            <!-- Basic Information -->
            <div class="form-section">
                <div class="section-title">Basic Information</div>
                
                <div class="form-group">
                    <label for="displayName">Display Name *</label>
                    <input type="text" id="displayName" name="displayName" required>
                </div>
                
                <div class="form-group">
                    <label for="bio">Bio (Tell us about yourself)</label>
                    <textarea id="bio" name="bio" placeholder="Share your photography journey, style, or what drives your artistic vision..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="userType">I am a... *</label>
                    <select id="userType" name="userType" required>
                        <option value="">Select your role</option>
                        <option value="photographer">Photographer</option>
                        <option value="model">Model</option>
                        <option value="both">Both Photographer & Model</option>
                        <option value="client">Client</option>
                        <option value="viewer">Photography Enthusiast</option>
                    </select>
                </div>
            </div>
            
            <!-- Photography Styles -->
            <div class="form-section">
                <div class="section-title">Photography Styles</div>
                <div class="checkbox-group" id="photographyStyles">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Location -->
            <div class="form-section">
                <div class="section-title">Location</div>
                
                <div class="form-group-inline">
                    <div class="form-group">
                        <label for="country">Country</label>
                        <input type="text" id="country" name="country" placeholder="e.g., United States">
                    </div>
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" id="city" name="city" placeholder="e.g., New York">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="zipCode">Zip/Postal Code</label>
                    <input type="text" id="zipCode" name="zipCode" placeholder="e.g., 10001">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="willingToTravel" name="willingToTravel">
                        I'm willing to travel for shoots
                    </label>
                </div>
            </div>
            
            <!-- Contact Information -->
            <div class="form-section">
                <div class="section-title">Contact Information</div>
                
                <div class="form-group">
                    <label for="workEmail">Work Email (optional)</label>
                    <input type="email" id="workEmail" name="workEmail" placeholder="your.business@email.com">
                </div>
                
                <div class="form-group-inline">
                    <div class="form-group">
                        <label for="phone">Phone (optional)</label>
                        <input type="tel" id="phone" name="phone" placeholder="+1 (555) 123-4567">
                    </div>
                    <div class="form-group">
                        <label for="website">Website/Portfolio (optional)</label>
                        <input type="url" id="website" name="website" placeholder="https://yourportfolio.com">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="instagramHandle">Instagram Handle (optional)</label>
                    <input type="text" id="instagramHandle" name="instagramHandle" placeholder="@yourhandle">
                </div>
            </div>
            
            <!-- Privacy Settings -->
            <div class="form-section">
                <div class="section-title">Privacy Settings</div>
                
                <div class="form-group">
                    <label for="profileVisibility">Profile Visibility</label>
                    <select id="profileVisibility" name="profileVisibility">
                        <option value="public">Public (visible to everyone)</option>
                        <option value="private">Private (visible only to connections)</option>
                        <option value="photographers_only">Photographers only</option>
                        <option value="models_only">Models only</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="allowMessages" name="allowMessages" checked>
                        Allow other users to message me
                    </label>
                </div>
            </div>
            
            <button type="submit" class="btn" id="submitBtn">Complete Registration</button>
            
            <div class="loading" id="loading">
                Creating your profile...
            </div>
        </form>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC_IVsN5eNO9jD4hxkb_VvnvLYbgbJnxl8",
            authDomain: "lumen-photo-app-20250731.firebaseapp.com",
            projectId: "lumen-photo-app-20250731",
            storageBucket: "lumen-photo-app-20250731.appspot.com",
            messagingSenderId: "1017024720063",
            appId: "1:1017024720063:web:8b9e6c4d1f3a5f2e9b8c7d"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const API_BASE = 'http://100.106.201.33:8080/api/v1';

        // DOM elements
        const form = document.getElementById('registrationForm');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const loading = document.getElementById('loading');
        const submitBtn = document.getElementById('submitBtn');

        // Load photography styles
        async function loadPhotographyStyles() {
            try {
                const response = await fetch(`${API_BASE}/users/styles`);
                const styles = await response.json();
                
                const container = document.getElementById('photographyStyles');
                container.innerHTML = '';
                
                styles.forEach(style => {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = style;
                    checkbox.name = 'photographyStyles';
                    checkbox.value = style;
                    
                    const label = document.createElement('label');
                    label.htmlFor = style;
                    label.textContent = style.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    label.style.cursor = 'pointer';
                    label.style.margin = '0';
                    
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    
                    // Handle visual selection
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            div.classList.add('selected');
                        } else {
                            div.classList.remove('selected');
                        }
                    });
                    
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading photography styles:', error);
            }
        }

        // Check authentication status
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // Redirect to login if not authenticated
                window.location.href = '/lumen-app.html';
                return;
            }
            
            // Check if user already has a profile - if so, redirect to main app
            try {
                const idToken = await user.getIdToken();
                const response = await fetch(`${API_BASE}/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${idToken}`
                    }
                });
                
                if (response.ok) {
                    // User already has a profile, redirect to main app
                    window.location.href = '/lumen-app.html';
                    return;
                } else if (response.status === 404) {
                    // User profile not found - stay on registration page
                    console.log('User needs to complete registration - no profile found');
                    return;
                } else {
                    // Other error - assume needs registration
                    console.log('Error checking profile, assuming needs registration:', response.status);
                    return;
                }
            } catch (error) {
                // Network or other error - assume user needs to register
                console.log('User needs to complete registration - error:', error);
            }
        });

        // Handle form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user = auth.currentUser;
            if (!user) {
                showError('Please log in to complete registration');
                return;
            }

            // Show loading state
            loading.style.display = 'block';
            submitBtn.disabled = true;
            hideMessages();

            try {
                // Get form data
                const formData = new FormData(form);
                const selectedStyles = Array.from(document.querySelectorAll('input[name="photographyStyles"]:checked'))
                    .map(cb => cb.value);

                // Build registration payload
                const registrationData = {
                    display_name: formData.get('displayName'),
                    bio: formData.get('bio') || null,
                    user_type: formData.get('userType') || null,
                    photography_styles: selectedStyles,
                    country: formData.get('country') || null,
                    city: formData.get('city') || null,
                    zip_code: formData.get('zipCode') || null,
                    willing_to_travel: formData.has('willingToTravel'),
                    work_email: formData.get('workEmail') || null,
                    phone: formData.get('phone') || null,
                    website: formData.get('website') || null,
                    instagram_handle: formData.get('instagramHandle') || null,
                    profile_visibility: formData.get('profileVisibility'),
                    allow_messages: formData.has('allowMessages'),
                    preferred_language: 'en',
                    metadata: {}
                };

                // Get Firebase ID token
                const idToken = await user.getIdToken();

                // Submit registration
                const response = await fetch(`${API_BASE}/users/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify(registrationData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Registration failed');
                }

                const result = await response.json();
                showSuccess('Profile created successfully! Redirecting to your dashboard...');
                
                // Redirect after a short delay
                setTimeout(() => {
                    window.location.href = '/lumen-app.html';
                }, 2000);

            } catch (error) {
                console.error('Registration error:', error);
                showError(error.message || 'Registration failed. Please try again.');
            } finally {
                loading.style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadPhotographyStyles();
        });
    </script>
</body>
</html>